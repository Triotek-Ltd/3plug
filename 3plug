#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CMD_NAME="${1:-}"

find_launcher() {
  local base="$1"
  if [[ -x "$base/env/bin/3plug" ]]; then
    echo "$base/env/bin/3plug"
    return 0
  fi
  if [[ -x "$base/env/Scripts/3plug.exe" ]]; then
    echo "$base/env/Scripts/3plug.exe"
    return 0
  fi
  if [[ -x "$base/.venv/bin/3plug" ]]; then
    echo "$base/.venv/bin/3plug"
    return 0
  fi
  if [[ -x "$base/.venv/Scripts/3plug.exe" ]]; then
    echo "$base/.venv/Scripts/3plug.exe"
    return 0
  fi
  return 1
}

find_python() {
  local base="$1"
  if [[ -x "$base/env/bin/python3" ]]; then
    echo "$base/env/bin/python3"
    return 0
  fi
  if [[ -x "$base/env/bin/python" ]]; then
    echo "$base/env/bin/python"
    return 0
  fi
  if [[ -x "$base/env/Scripts/python.exe" ]]; then
    echo "$base/env/Scripts/python.exe"
    return 0
  fi
  return 1
}

if [[ "$CMD_NAME" == "setup" || "$CMD_NAME" == "init" || "$CMD_NAME" == "setup-dev-env" ]]; then
  if ! PYTHON_EXE="$(find_python "$ROOT_DIR")"; then
    echo "Bootstrapping local virtual environment at env..."
    (cd "$ROOT_DIR" && (python3 -m venv env || python -m venv env))
    PYTHON_EXE="$(find_python "$ROOT_DIR")"
  fi

  if ! LAUNCHER="$(find_launcher "$ROOT_DIR")"; then
    echo "Installing 3plug into local virtual environment..."
    (cd "$ROOT_DIR" && "$PYTHON_EXE" -m pip install -e .)
    LAUNCHER="$(find_launcher "$ROOT_DIR")"
  fi

  exec "$LAUNCHER" "$@"
fi

if LAUNCHER="$(find_launcher "$ROOT_DIR")"; then
  exec "$LAUNCHER" "$@"
fi

echo "3plug virtual environment not found. Run: python3 -m venv env && ./env/bin/python -m pip install -e . (or Windows env\\Scripts\\python.exe -m pip install -e .)"
exit 1
